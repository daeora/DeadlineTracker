<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="DeadlineTracker.ProjectEditPage"
             Title="Muokkaa projektia">
    
    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Tyylit -->
            <Style TargetType="Frame">
                <Setter Property="CornerRadius" Value="14" />
                <Setter Property="Padding" Value="12" />
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#fff7ff, Dark=#141418}" />
                <Setter Property="BorderColor" Value="{DynamicResource SecondaryTextColor}" />
            </Style>
            <Style x:Key="SectionTitle" TargetType="Label">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="Margin" Value="6,0,0,6" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <Grid Padding="20"
          RowSpacing="16"
          RowDefinitions="Auto,Auto,Auto,Auto,Auto,*,Auto"
          ColumnDefinitions="*">

            <!-- Otsikko -->
            <Label Grid.Row="0" Text="Muokkaa projektia" FontSize="24" FontAttributes="Bold" />

            <!-- Projektin nimi -->
            <Grid Grid.Row="1" RowDefinitions="Auto,Auto">
                <Label Text="Projektin nimi" Style="{StaticResource SectionTitle}" />
                <Frame Grid.Row="1">
                    <Entry x:Name="NameEntry" Placeholder="Esim. Projekti 1" />
                </Frame>
            </Grid>

            <!-- Kuvaus -->
            <Grid Grid.Row="2" RowDefinitions="Auto,Auto">
                <Label Text="Kuvaus" Style="{StaticResource SectionTitle}" />
                <Frame Grid.Row="1">
                    <Editor x:Name="DescEditor" Placeholder="Lyhyt kuvaus projektista" AutoSize="TextChanges" />
                </Frame>
            </Grid>

            <!-- Alkamispäivä -->
            <Grid Grid.Row="3" RowDefinitions="Auto,Auto">
                <Label Text="Alkamispäivä" Style="{StaticResource SectionTitle}" />
                <Frame Grid.Row="1">
                    <DatePicker x:Name="StartDatePicker" />
                </Frame>
            </Grid>

            <!-- Loppupäivä -->
            <Grid Grid.Row="4" RowDefinitions="Auto,Auto">
                <Label Text="Loppupäivä" Style="{StaticResource SectionTitle}" />
                <Frame Grid.Row="1">
                    <DatePicker x:Name="EndDatePicker" />
                </Frame>
            </Grid>

            <!-- Kaksi palstaa -->
            <Grid Grid.Row="5" ColumnDefinitions="*,*" ColumnSpacing="16">

                <!-- TEHTÄVÄT -->
                <Grid Grid.Column="0" RowDefinitions="Auto,Auto">
                    <Label Grid.Row="0" Text="Tehtävät" Style="{StaticResource SectionTitle}" />
                    <Frame Grid.Row="1">

                        <CollectionView ItemsSource="{Binding Tasks}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <!-- Rivi: yläosa (checkbox, otsikko, deadline, poista tehtävä) + alaosa (vastuuhenkilöt & haku) -->
                                    <Grid Padding="6" ColumnSpacing="8" RowDefinitions="Auto,Auto" ColumnDefinitions="32,*,Auto,Auto">

                                        <!-- yläosa -->
                                        <CheckBox Grid.Row="0" Grid.Column="0" IsChecked="{Binding Done}" VerticalOptions="Center"/>
                                        <Label   Grid.Row="0" Grid.Column="1" Text="{Binding Title}" VerticalOptions="Center"/>

                                        <!-- Deadline -->
                                        <DatePicker Grid.Row="0" Grid.Column="2"
                                                    Date="{Binding DueDate}"
                                                    HorizontalOptions="End"
                                                    DateSelected="TaskDueDate_DateSelected" />

                                        <!-- Poista tehtävärivi -->
                                        <Button Grid.Row="0" Grid.Column="3"
                                                Text="Poista"
                                                Clicked="DeleteTask_Clicked"/>

                                        <!-- alaosa: vastuuhenkilöt + haku -->
                                        <Grid Grid.Row="1" Grid.ColumnSpan="3" RowDefinitions="Auto,Auto,Auto" RowSpacing="6">

                                            <!-- valitut assigneet "tageina" -->
                                            <HorizontalStackLayout Spacing="6">
                                                <HorizontalStackLayout
                                                BindableLayout.ItemsSource="{Binding Assignees}">
                                                    <BindableLayout.ItemTemplate>
                                                        <DataTemplate>
                                                            <Frame Padding="6,2" CornerRadius="12" HasShadow="False" BackgroundColor="#333">
                                                                <Grid ColumnDefinitions="Auto,Auto" ColumnSpacing="6">
                                                                    <Label Text="{Binding FullName}" TextColor="White"/>
                                                                    <Button Grid.Column="1" Text="X" WidthRequest="16" HeightRequest="16"
                                                                                BackgroundColor="Transparent" Padding="0"
                                                                                Clicked="TaskRemoveAssignee_Clicked"/>
                                                                </Grid>
                                                            </Frame>
                                                        </DataTemplate>
                                                    </BindableLayout.ItemTemplate>
                                                </HorizontalStackLayout>
                                            </HorizontalStackLayout>

                                            <!-- hakuentry -->
                                            <Entry Grid.Row="1"
                                               Placeholder="Lisää vastuuhenkilö…"
                                               Text="{Binding SearchText}"
                                               TextChanged="TaskAssigneeSearch_TextChanged"/>

                                            <!-- ehdotukset -->
                                            <Frame Grid.Row="2" HasShadow="False" Padding="0"
                                               IsVisible="{Binding AreUserSuggestionsVisible}">
                                                <CollectionView ItemsSource="{Binding FilteredUsers}"
                                                                SelectionMode="Single"
                                                                SelectionChanged="TaskAssigneeSuggestion_SelectionChanged"
                                                                HeightRequest="140">
                                                    <CollectionView.ItemTemplate>
                                                        <DataTemplate>
                                                            <Grid Padding="10">
                                                                <Label Text="{Binding Name}" />
                                                            </Grid>
                                                        </DataTemplate>
                                                    </CollectionView.ItemTemplate>
                                                </CollectionView>
                                            </Frame>

                                        </Grid>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>

                            <!-- Footer: uusi tehtävä -->
                            <CollectionView.Footer>
                                <Grid Padding="8,6" ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                    <Entry x:Name="NewTaskEntry" Placeholder="Uusi tehtävä..." />
                                    <Button Grid.Column="1" Text="Lisää" Clicked="AddTask_Clicked" />
                                </Grid>
                            </CollectionView.Footer>

                        </CollectionView>

                    </Frame>
                </Grid>

                <!-- OSALLISTUJAT -->
                <Grid Grid.Column="1" RowDefinitions="Auto,Auto">
                    <Label Grid.Row="0" Text="Osallistujat" Style="{StaticResource SectionTitle}" />
                    <Frame Grid.Row="1">
                        <CollectionView ItemsSource="{Binding Participants}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="*,Auto" Padding="6" RowSpacing="4">
                                        <Label Text="{Binding FullName}" />
                                        <Button Grid.Column="2"
                                                Text="Poista"
                                                Clicked="DeleteParticipant_Clicked"
                                                SemanticProperties.Hint="Poista osallistuja" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>

                            <CollectionView.Footer>
                                <Grid Padding="8,6" RowDefinitions="Auto,Auto" RowSpacing="8">
                                    <!-- Hakukenttä -->
                                    <Entry x:Name="ParticipantSearchEntry"
                                          Placeholder="Hae käyttäjää nimellä..."
                                          TextChanged="ParticipantSearchEntry_TextChanged" 
                                          Unfocused="ParticipantSearch_Unfocused" />

                                    <!-- Dropdown-ehdotukset -->
                                    <Frame Grid.Row="1" HasShadow="False" Padding="0"
                                       IsVisible="{Binding AreUserSuggestionsVisible}">
                                        <CollectionView x:Name="UserSuggestionsView"
                                                        ItemsSource="{Binding FilteredUsers}"
                                                        SelectionMode="Single"
                                                        HeightRequest="180"
                                                        SelectionChanged="UserSuggestions_SelectionChanged">
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Grid Padding="10">
                                                        <Label Text="{Binding Name}" />
                                                    </Grid>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>
                                    </Frame>
                                </Grid>
                            </CollectionView.Footer>
                        </CollectionView>
                    </Frame>
                </Grid>

            </Grid>

            <!-- Alapalkki: Peruuta | Poista projekti | Tallenna muutokset -->
            <Grid Grid.Row="6" ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="12">
                <Button Grid.Column="0" Text="Peruuta" Clicked="Cancel_Clicked" />
                <Label Grid.Column="1" />
                <Button Grid.Column="2" Text="Poista projekti"
                        BackgroundColor="#b00020" TextColor="White"
                        Clicked="DeleteProject_Clicked" />
                <Button Grid.Column="3" Text="Tallenna muutokset"
                        Clicked="SaveChanges_Clicked" />
            </Grid>

        </Grid>
    </ScrollView>
</ContentPage>