<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="DeadlineTracker.ProjectEditPage"
             Title="Muokkaa projektia"
             BackgroundColor="{StaticResource Secondary}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Tyylit -->
            <Style x:Key="SectionTitle" TargetType="Label">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="TextColor" Value="{StaticResource MidnightBlue}" />
                <Setter Property="Margin" Value="4,0,0,6" />
            </Style>

            <Style x:Key="InputBorder" TargetType="Border">
                <Setter Property="Stroke" Value="{StaticResource Gray400}" />
                <Setter Property="StrokeThickness" Value="1" />
                <Setter Property="StrokeShape" Value="RoundRectangle 8" />
                <Setter Property="BackgroundColor" Value="{StaticResource White}" />
                <Setter Property="Padding" Value="10,0" />
                <Setter Property="HeightRequest" Value="45" />
            </Style>

            <Style x:Key="SmallInputBorder" TargetType="Border">
                <Setter Property="Stroke" Value="{StaticResource Gray300}" />
                <Setter Property="StrokeThickness" Value="1" />
                <Setter Property="StrokeShape" Value="RoundRectangle 6" />
                <Setter Property="BackgroundColor" Value="{StaticResource White}" />
                <Setter Property="Padding" Value="8,0" />
                <Setter Property="HeightRequest" Value="40" />
                <Setter Property="VerticalOptions" Value="Center" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <Grid Padding="25"
              RowSpacing="20"
              RowDefinitions="Auto,Auto,Auto,Auto,Auto,*,Auto"
              ColumnDefinitions="*">

            <!-- Otsikko -->
            <Label Grid.Row="0" 
                   Text="Muokkaa projektia" 
                   FontSize="28" 
                   FontAttributes="Bold" 
                   TextColor="{StaticResource MidnightBlue}"/>

            <!-- Projektin nimi -->
            <VerticalStackLayout Grid.Row="1" Spacing="0">
                <Label Text="Projektin nimi" Style="{StaticResource SectionTitle}" />
                <Border Style="{StaticResource InputBorder}">
                    <Entry x:Name="NameEntry" 
                           Placeholder="Esim. Projekti 1" 
                           TextColor="{StaticResource Gray900}"
                           PlaceholderColor="{StaticResource Gray400}"
                           VerticalOptions="Center"/>
                </Border>
            </VerticalStackLayout>

            <!-- Kuvaus -->
            <VerticalStackLayout Grid.Row="2" Spacing="0">
                <Label Text="Kuvaus" Style="{StaticResource SectionTitle}" />
                <Border Style="{StaticResource InputBorder}" HeightRequest="100" Padding="10">
                    <Editor x:Name="DescEditor" 
                            Placeholder="Lyhyt kuvaus projektista" 
                            TextColor="{StaticResource Gray900}"
                            PlaceholderColor="{StaticResource Gray400}"
                            AutoSize="TextChanges" />
                </Border>
            </VerticalStackLayout>

            <!-- Alkamispäivä -->
            <Grid Grid.Row="3" ColumnDefinitions="*,*" ColumnSpacing="15">
                <VerticalStackLayout Grid.Column="0" Spacing="0">
                    <Label Text="Alkamispäivä" Style="{StaticResource SectionTitle}" />
                    <Border Style="{StaticResource InputBorder}">
                        <DatePicker x:Name="StartDatePicker" TextColor="{StaticResource Gray900}"/>
                    </Border>
                </VerticalStackLayout>

                <!-- Loppupäivä -->
                <VerticalStackLayout Grid.Column="1" Spacing="0">
                    <Label Text="Loppupäivä" Style="{StaticResource SectionTitle}" />
                    <Border Style="{StaticResource InputBorder}">
                        <DatePicker x:Name="EndDatePicker" TextColor="{StaticResource Gray900}"/>
                    </Border>
                </VerticalStackLayout>
            </Grid>

            <!-- Kaksi palstaa -->
            <Grid Grid.Row="5" ColumnDefinitions="*,*" ColumnSpacing="20">

                <!-- TEHTÄVÄT -->
                <Border Grid.Column="0" 
                        BackgroundColor="{StaticResource White}"
                        Stroke="{StaticResource Gray300}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 12"
                        Padding="15"
                        VerticalOptions="Fill">

                    <VerticalStackLayout Spacing="10">
                        <Label Text="Tehtävät" Style="{StaticResource SectionTitle}" FontSize="18"/>

                        <CollectionView ItemsSource="{Binding Tasks}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <!-- yläosa (checkbox, otsikko, deadline, poista tehtävä) + alaosa (vastuuhenkilöt & haku) -->
                                    <Border Stroke="{StaticResource Gray200}"
                                            StrokeThickness="1"
                                            StrokeShape="RoundRectangle 8"
                                            Padding="10"
                                            Margin="0,4"
                                            BackgroundColor="{StaticResource White}">

                                        <VerticalStackLayout Spacing="8">
                                            <Grid ColumnDefinitions="30,*,Auto,Auto" RowDefinitions="Auto" ColumnSpacing="8">

                                                <!-- yläosa -->
                                                <CheckBox Grid.Column="0" IsChecked="{Binding Done}" Color="{StaticResource Primary}" VerticalOptions="Center"/>

                                                <Label Grid.Column="1" Text="{Binding Title}" VerticalOptions="Center" TextColor="{StaticResource Gray900}" FontAttributes="Bold"/>

                                                <!-- Deadline -->
                                                <Border Grid.Column="2" Style="{StaticResource SmallInputBorder}">
                                                    <DatePicker Date="{Binding DueDate}"
                                                                TextColor="{StaticResource Gray600}"
                                                                FontSize="12"
                                                                VerticalOptions="Center"/>
                                                </Border>

                                                <!-- Poista tehtävärivi -->
                                                <Button Grid.Column="3"
                                                        Text="✕"
                                                        TextColor="Red"
                                                        BackgroundColor="Transparent"
                                                        FontSize="16"
                                                        Padding="0"
                                                        WidthRequest="30"
                                                        Clicked="DeleteTask_Clicked"/>
                                            </Grid>

                                            <!-- alaosa: vastuuhenkilöt + haku -->
                                            <HorizontalStackLayout Spacing="4" BindableLayout.ItemsSource="{Binding Assignees}">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border StrokeThickness="0" BackgroundColor="{StaticResource Primary}" StrokeShape="RoundRectangle 10" Padding="8,2">
                                                            <Grid ColumnDefinitions="Auto,Auto" ColumnSpacing="4">
                                                                <Label Text="{Binding FullName}" TextColor="White" FontSize="10" VerticalOptions="Center"/>
                                                                <Button Grid.Column="1" Text="✕" TextColor="White" BackgroundColor="Transparent" 
                                                                        FontSize="10" Padding="0" HeightRequest="16" WidthRequest="16"
                                                                        Clicked="TaskRemoveAssignee_Clicked"/>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </HorizontalStackLayout>

                                            <!-- hakuentry -->
                                            <Grid RowDefinitions="Auto, Auto">
                                                <Border Style="{StaticResource SmallInputBorder}">
                                                    <Entry Placeholder="Lisää vastuuhenkilö..." 
                                                           Text="{Binding SearchText}"
                                                           TextChanged="TaskAssigneeSearch_TextChanged"
                                                           FontSize="12" 
                                                           TextColor="{StaticResource Gray900}"
                                                           VerticalOptions="Center"/>
                                                </Border>

                                                <!-- ehdotukset -->
                                                <Frame Grid.Row="1" HasShadow="True" Padding="0" Margin="0,5,0,0"
                                                       IsVisible="{Binding AreUserSuggestionsVisible}"
                                                       BackgroundColor="White"
                                                       BorderColor="{StaticResource Gray200}"
                                                       ZIndex="100">
                                                    <CollectionView ItemsSource="{Binding FilteredUsers}"
                                                                    SelectionMode="Single"
                                                                    SelectionChanged="TaskAssigneeSuggestion_SelectionChanged"
                                                                    HeightRequest="120">
                                                        <CollectionView.ItemTemplate>
                                                            <DataTemplate>
                                                                <Grid Padding="8">
                                                                    <Label Text="{Binding Name}" TextColor="{StaticResource Gray900}" FontSize="12"/>
                                                                </Grid>
                                                            </DataTemplate>
                                                        </CollectionView.ItemTemplate>
                                                    </CollectionView>
                                                </Frame>
                                            </Grid>
                                        </VerticalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <!-- Footer: uusi tehtävä -->
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" Margin="0,5,0,0">
                            <Border Style="{StaticResource InputBorder}" HeightRequest="40">
                                <Entry x:Name="NewTaskEntry" Placeholder="Uusi tehtävä..." FontSize="13" TextColor="{StaticResource Gray900}" VerticalOptions="Center"/>
                            </Border>
                            <Button Grid.Column="1" Text="Lisää" Clicked="AddTask_Clicked" BackgroundColor="{StaticResource Primary}" TextColor="White" HeightRequest="40" CornerRadius="8"/>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!-- OSALLISTUJAT -->
                <Border Grid.Column="1" 
                        BackgroundColor="{StaticResource White}"
                        Stroke="{StaticResource Gray300}"
                        StrokeThickness="1"
                        StrokeShape="RoundRectangle 12"
                        Padding="15"
                        VerticalOptions="Fill">

                    <VerticalStackLayout Spacing="10">
                        <Label Text="Osallistujat" Style="{StaticResource SectionTitle}" FontSize="18"/>

                        <CollectionView ItemsSource="{Binding Participants}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border Stroke="{StaticResource Gray200}" StrokeThickness="1" StrokeShape="RoundRectangle 8" Padding="10" Margin="0,4">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <Label Text="{Binding FullName}" TextColor="{StaticResource Gray900}" VerticalOptions="Center"/>
                                            <Button Grid.Column="1"
                                                    Text="Poista"
                                                    TextColor="Red"
                                                    BackgroundColor="Transparent"
                                                    FontSize="12"
                                                    Clicked="DeleteParticipant_Clicked" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <!-- Hakukenttä -->
                        <Grid RowDefinitions="Auto,Auto" Margin="0,10,0,0">
                            <Border Style="{StaticResource InputBorder}" HeightRequest="40">
                                <Entry x:Name="ParticipantSearchEntry"
                                       Placeholder="Hae käyttäjää..."
                                       TextColor="{StaticResource Gray900}"
                                       FontSize="13"
                                       VerticalOptions="Center"
                                       TextChanged="ParticipantSearchEntry_TextChanged" 
                                       Unfocused="ParticipantSearch_Unfocused" />
                            </Border>

                            <!-- Dropdown-ehdotukset -->
                            <Border Grid.Row="1" Stroke="{StaticResource Gray300}" BackgroundColor="White" Padding="0"
                                    IsVisible="{Binding AreUserSuggestionsVisible}"
                                    ZIndex="100"
                                    MaximumHeightRequest="150"
                                    VerticalOptions="Start">
                                <CollectionView x:Name="UserSuggestionsView"
                                                ItemsSource="{Binding FilteredUsers}"
                                                SelectionMode="Single"
                                                HeightRequest="150"
                                                SelectionChanged="UserSuggestions_SelectionChanged">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Padding="10" BackgroundColor="White">
                                                <Label Text="{Binding Name}" TextColor="{StaticResource Gray900}"/>
                                                <VisualStateManager.VisualStateGroups>
                                                    <VisualStateGroup x:Name="CommonStates">
                                                        <VisualState x:Name="Normal" />
                                                        <VisualState x:Name="Selected">
                                                            <VisualState.Setters>
                                                                <Setter Property="BackgroundColor" Value="{StaticResource Gray100}" />
                                                            </VisualState.Setters>
                                                        </VisualState>
                                                    </VisualStateGroup>
                                                </VisualStateManager.VisualStateGroups>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Border>
                        </Grid>
                    </VerticalStackLayout>
                </Border>
            </Grid>

            <!-- Alapalkki: Peruuta | Poista projekti | Tallenna muutokset -->
            <Grid Grid.Row="6" ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="12" Margin="0,20,0,0">
                <Button Grid.Column="0" 
                        Text="Peruuta" 
                        Clicked="Cancel_Clicked" 
                        BackgroundColor="{StaticResource Gray200}"
                        TextColor="{StaticResource Gray900}"
                        FontAttributes="Bold"
                        CornerRadius="8"
                        HeightRequest="45"
                        WidthRequest="100"/>

                <Button Grid.Column="2" 
                        Text="Poista projekti"
                        Clicked="DeleteProject_Clicked" 
                        BackgroundColor="#d32f2f" 
                        TextColor="White"
                        FontAttributes="Bold"
                        CornerRadius="8"
                        HeightRequest="45"/>

                <Button Grid.Column="3" 
                        Text="Tallenna muutokset"
                        Clicked="SaveChanges_Clicked" 
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        FontAttributes="Bold"
                        CornerRadius="8"
                        HeightRequest="45">
                    <Button.Shadow>
                        <Shadow Brush="{StaticResource Primary}" Offset="0,4" Opacity="0.3" Radius="10"/>
                    </Button.Shadow>
                </Button>
            </Grid>

        </Grid>
    </ScrollView>
</ContentPage>